<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Îâ¥Ïä§ Ïä§ÌéôÌä∏Îüº: ÌïúÍµ≠ ÌÜ†ÌîΩ ÎπÑÏª§</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: linear-gradient(135deg, #E3F2FD 0%, #F3E5F5 100%);
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', system-ui, sans-serif;
            color: #1d1d1f;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        @font-face {
            font-family: 'Pretendard';
            src: url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.6/dist/web/static/woff2/Pretendard-Regular.woff2') format('woff2');
            font-weight: 400;
            font-display: swap;
        }
        @font-face {
            font-family: 'Pretendard';
            src: url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.6/dist/web/static/woff2/Pretendard-Bold.woff2') format('woff2');
            font-weight: 700;
            font-display: swap;
        }

        .container {
            position: relative;
            width: 900px;
            height: 700px;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(40px) saturate(180%);
            -webkit-backdrop-filter: blur(40px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 40px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
        }

        svg {
            background-color: transparent;
        }

        .node {
            cursor: pointer;
            stroke: rgba(255, 255, 255, 0.8);
            stroke-width: 3px;
            filter: drop-shadow(0 2px 8px rgba(0, 0, 0, 0.1));
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .node.megatopic {
            stroke: #007AFF;
            stroke-width: 4px;
            filter: drop-shadow(0 4px 12px rgba(0, 122, 255, 0.3));
        }
        .node:hover {
            filter: drop-shadow(0 8px 24px rgba(0, 0, 0, 0.15));
        }

        .node-label {
            fill: #000;
            text-anchor: middle;
            pointer-events: none;
            font-size: 13px;
            font-weight: 700;
            opacity: 1;
        }
        .node-group.hovered .node-label {
            font-weight: 900;
            font-size: 15px;
        }

        .country-tabs {
            position: absolute;
            top: 24px;
            right: 24px;
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 8px;
            border-radius: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            max-width: 400px;
            border: 1px solid rgba(0, 0, 0, 0.04);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06);
        }
        .country-tab {
            padding: 8px 16px;
            border: none;
            border-radius: 16px;
            background: rgba(255, 255, 255, 0.5);
            cursor: pointer;
            font-size: 17px;
            font-weight: 500;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            user-select: none;
        }
        .country-tab:hover {
            background: rgba(255, 255, 255, 0.9);
            transform: translateY(-1px);
        }
        .country-tab.active {
            background: #007AFF;
            color: white;
            box-shadow: 0 2px 8px rgba(0, 122, 255, 0.3);
        }

        .header {
            position: absolute;
            top: 24px;
            left: 24px;
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 16px 24px;
            border-radius: 20px;
            border: 1px solid rgba(0, 0, 0, 0.04);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06);
        }
        .header h1 {
            margin: 0;
            font-size: 28px;
            font-weight: 700;
            color: #1d1d1f;
            letter-spacing: -0.5px;
        }
        .header .subtitle {
            margin: 6px 0 0 0;
            font-size: 13px;
            color: #6e6e73;
            font-weight: 400;
        }

        .loading-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 20px;
            font-weight: 500;
            color: #6e6e73;
            letter-spacing: -0.3px;
        }
    </style>
</head>
<body>
    <div class="container">
        <svg width="100%" height="100%"></svg>
        <div class="loading-text">Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Ï§ë...</div>
    </div>

    <div class="header">
        <h1 id="pageTitle">üá∞üá∑ ÌïúÍµ≠ ÌÜ†ÌîΩ ÎπÑÏª§</h1>
        <div class="subtitle">ÌÅ¨Í∏∞ = Í∏∞ÏÇ¨ Ïàò | Í∏àÏÉâ ÌÖåÎëêÎ¶¨ = Î©îÍ∞ÄÌÜ†ÌîΩ | ÌÅ¥Î¶≠ ‚Üí ÏÉÅÏÑ∏Î≥¥Í∏∞</div>
    </div>

    <div class="country-tabs" id="countryTabs"></div>

    <script>
        const width = 900;
        const height = 700;

        const svg = d3.select("svg");
        const loadingText = d3.select(".loading-text");

        // URL ÌååÎùºÎØ∏ÌÑ∞ÏóêÏÑú Íµ≠Í∞Ä ÏΩîÎìú ÏùΩÍ∏∞
        const urlParams = new URLSearchParams(window.location.search);
        const selectedCountry = urlParams.get('country') || 'KR';

        // iOS ÏãúÏä§ÌÖú Ïª¨Îü¨ ÌåîÎ†àÌä∏
        const colorPalette = [
            '#007AFF', // Blue
            '#34C759', // Green
            '#FF9500', // Orange
            '#FF375F', // Pink
            '#AF52DE', // Purple
            '#5AC8FA', // Teal
            '#FFCC00', // Yellow
            '#FF2D55', // Red
            '#5856D6', // Indigo
            '#32ADE6', // Light Blue
            '#30D158', // Mint
            '#FFD60A', // Amber
            '#BF5AF2', // Violet
            '#64D2FF', // Cyan
            '#FF453A', // Crimson
            '#0A84FF', // Azure
            '#30B0C7', // Aqua
            '#FFB340', // Tangerine
            '#FF6482', // Rose
            '#AC8E68', // Brown
            '#98989D', // Gray
            '#8E8E93'  // Cool Gray
        ];

        // Íµ≠Í∞Ä ÌîåÎûòÍ∑∏ Îß§Ìïë
        const countryFlags = {
            'US': 'üá∫üá∏', 'GB': 'üá¨üáß', 'KR': 'üá∞üá∑', 'DE': 'üá©üá™',
            'FR': 'üá´üá∑', 'JP': 'üáØüáµ', 'CN': 'üá®üá≥', 'IT': 'üáÆüáπ',
            'CA': 'üá®üá¶', 'RU': 'üá∑üá∫', 'IN': 'üáÆüá≥', 'BR': 'üáßüá∑'
        };

        // ID Í∏∞Î∞ò ÏÉâÏÉÅ Ìï†Îãπ (ÏùºÍ¥ÄÏÑ± Ïú†ÏßÄ)
        function getColorById(id) {
            return colorPalette[id % colorPalette.length];
        }

        async function drawChart() {
            try {
                const response = await fetch('/api/topics?limit=500');
                const apiResponse = await response.json();
                const allTopics = apiResponse.data || [];

                console.log(`Total API topics: ${allTopics.length}`);
                console.log('Sample topics:', allTopics.slice(0, 5).map(t => ({
                    id: t.id,
                    title_kr: t.title_kr?.substring(0, 30),
                    countries: t.countries_involved,
                    article_count: t.article_count
                })));

                // countries_involved Î∂ÑÌè¨ ÌôïÏù∏
                const topicsWithCountries = allTopics.filter(t => t.countries_involved && t.countries_involved.length > 0);
                const topicsWithoutCountries = allTopics.filter(t => !t.countries_involved || t.countries_involved.length === 0);
                console.log(`Topics with countries_involved: ${topicsWithCountries.length}`);
                console.log(`Topics WITHOUT countries_involved: ${topicsWithoutCountries.length}`);

                if (topicsWithoutCountries.length > 0) {
                    console.log('Sample topics without countries:', topicsWithoutCountries.slice(0, 3).map(t => ({
                        id: t.id,
                        title_kr: t.title_kr,
                        countries_involved: t.countries_involved
                    })));
                }

                // Ï†ÑÏ≤¥ ÌÜ†ÌîΩÏóêÏÑú Ïã§Ï†úÎ°ú Ï°¥Ïû¨ÌïòÎäî Íµ≠Í∞Ä Ï∂îÏ∂ú (ÌÉ≠Ïö©)
                const allCountriesInData = [...new Set(
                    allTopics.flatMap(t => t.countries_involved || [])
                )].sort();
                console.log('Countries with data:', allCountriesInData);

                // KR Ìè¨Ìï® ÌÜ†ÌîΩ Ï†ÑÏ≤¥ ÌôïÏù∏
                const allKRTopics = allTopics.filter(t => {
                    const countries = t.countries_involved || [];
                    return countries.includes(selectedCountry);
                });
                console.log(`Total KR-related topics in ALL data: ${allKRTopics.length}`);

                // ÏÑ†ÌÉùÎêú Íµ≠Í∞Ä Í¥ÄÎ†® ÌÜ†ÌîΩÎßå ÌïÑÌÑ∞ÎßÅ (Î©îÍ∞ÄÌÜ†ÌîΩ + Îã®ÎèÖ ÌÜ†ÌîΩ)
                const countryTopics = allTopics.filter(t => {
                    const countries = t.countries_involved || [];
                    return countries.includes(selectedCountry);
                });

                // Íµ≠Í∞ÄÎ≥Ñ Î∂ÑÎ•ò
                const nationalOnly = countryTopics.filter(t => t.countries_involved?.length === 1);
                const megatopics = countryTopics.filter(t => t.countries_involved?.length > 1);

                console.log(`${selectedCountry} Îã®ÎèÖ ÌÜ†ÌîΩ: ${nationalOnly.length}Í∞ú`);
                console.log(`${selectedCountry} Ìè¨Ìï® Î©îÍ∞ÄÌÜ†ÌîΩ: ${megatopics.length}Í∞ú`);
                console.log(`Ï¥ù ${countryTopics.length}Í∞ú ÌÜ†ÌîΩ`);

                // ÌéòÏù¥ÏßÄ ÌÉÄÏù¥ÌãÄ ÏóÖÎç∞Ïù¥Ìä∏
                const countryName = {
                    'KR': 'ÌïúÍµ≠', 'US': 'ÎØ∏Íµ≠', 'CN': 'Ï§ëÍµ≠', 'JP': 'ÏùºÎ≥∏',
                    'GB': 'ÏòÅÍµ≠', 'DE': 'ÎèÖÏùº', 'FR': 'ÌîÑÎûëÏä§', 'IT': 'Ïù¥ÌÉàÎ¶¨ÏïÑ',
                    'CA': 'Ï∫êÎÇòÎã§', 'RU': 'Îü¨ÏãúÏïÑ', 'IN': 'Ïù∏ÎèÑ', 'BR': 'Î∏åÎùºÏßà'
                }[selectedCountry] || selectedCountry;
                const countryFlag = countryFlags[selectedCountry] || '';
                d3.select("#pageTitle").text(`${countryFlag} ${countryName} ÌÜ†ÌîΩ ÎπÑÏª§`);

                loadingText.style("display", "none");

                // ÏÑ†ÌÉùÎêú Íµ≠Í∞Ä ÎÇ¥ Í∏∞ÏÇ¨ Ïàò Í≥ÑÏÇ∞
                const nodesData = countryTopics.map(topic => {
                    // APIÍ∞Ä statsÎ•º Î∞òÌôòÌïòÏßÄ ÏïäÏúºÎØÄÎ°ú Ï†ÑÏ≤¥ article_count ÏÇ¨Ïö©
                    const countryArticleCount = topic.article_count || 0;

                    const isMegatopic = (topic.countries_involved || []).length > 1;
                    const countries = topic.countries_involved || [];

                    // Íµ≠Í∞Ä ÌîåÎûòÍ∑∏ ÏÉùÏÑ±
                    const countryLabel = countries
                        .map(code => countryFlags[code] || code)
                        .join(' ');

                    return {
                        id: topic.id,
                        name: topic.title_kr || topic.title,
                        articleCount: countryArticleCount,
                        type: isMegatopic ? 'megatopic' : 'national',
                        countries: countries,
                        countryLabel: countryLabel,
                        color: getColorById(topic.id)
                    };
                }); // ÏûÑÏãú: ÌïÑÌÑ∞ Ï†úÍ±∞ (Í∏∞ÏÇ¨ Ïàò 0Ïù∏ Í≤ÉÎèÑ ÌëúÏãú)
                // .filter(d => d.articleCount > 0);

                console.log(`Total nodes before filter: ${countryTopics.length}`);
                console.log(`Nodes with articles: ${nodesData.length}`);
                console.log('First 5 nodes with article counts:', nodesData.slice(0, 5).map(d => ({
                    id: d.id,
                    name: d.name.substring(0, 20),
                    articleCount: d.articleCount,
                    countries: d.countries
                })));

                // Í∏∞ÏÇ¨ Ïàò Î∂ÑÌè¨ ÌôïÏù∏
                const articleCounts = nodesData.map(d => d.articleCount).sort((a, b) => b - a);
                console.log('Article count distribution:', {
                    max: articleCounts[0],
                    min: articleCounts[articleCounts.length - 1],
                    median: articleCounts[Math.floor(articleCounts.length / 2)],
                    sample: articleCounts.slice(0, 10)
                });

                if (nodesData.length === 0 && countryTopics.length > 0) {
                    const sample = countryTopics[0];
                    console.log('Sample topic (no articles):', {
                        id: sample.id,
                        title: sample.title_kr || sample.title,
                        stats: sample.stats,
                        countries_involved: sample.countries_involved
                    });
                }

                // ÌÅ¨Í∏∞ Ïä§ÏºÄÏùº
                const maxArticleCount = d3.max(nodesData, d => d.articleCount);
                const minArticleCount = d3.min(nodesData, d => d.articleCount);
                const radiusScale = d3.scaleSqrt()
                    .domain([0, maxArticleCount])
                    .range([10, 80]);

                console.log('Article count distribution:', {
                    min: minArticleCount,
                    max: maxArticleCount,
                    all: nodesData.map(d => d.articleCount).sort((a, b) => b - a)
                });

                const nodes = nodesData.map(d => {
                    const baseR = radiusScale(d.articleCount) * (d.type === 'megatopic' ? 1.2 : 1);
                    return {
                        ...d,
                        r: baseR,
                        targetR: baseR // Ìò∏Î≤Ñ Ïãú Î≥ÄÍ≤ΩÎê† Î™©Ìëú Î∞òÏßÄÎ¶Ñ
                    };
                });

                console.log('Radius calculations:', {
                    scale: {
                        domain: radiusScale.domain(),
                        range: radiusScale.range()
                    },
                    samples: nodes.slice(0, 5).map(d => ({
                        name: d.name.substring(0, 20),
                        articleCount: d.articleCount,
                        radius: d.r,
                        type: d.type
                    })),
                    allRadii: nodes.map(d => d.r).sort((a, b) => b - a)
                });

                console.log(`Rendering ${nodes.length} topics with articles`);

                // D3 Force Simulation
                const simulation = d3.forceSimulation(nodes)
                    .force("charge", d3.forceManyBody().strength(5))
                    .force("collide", d3.forceCollide().radius(d => d.targetR + 2).iterations(2))
                    .force("center", d3.forceCenter(width / 2, height / 2).strength(0.1))
                    .force("gravity", d3.forceY(height * 0.6).strength(0.15)) // Î∞îÎã• Ï™ΩÏúºÎ°ú Ï§ëÎ†•
                    .force("x", d3.forceX(width / 2).strength(0.03));

                const nodeGroup = svg.append("g");

                const nodeElements = nodeGroup.selectAll("g.node-group")
                    .data(nodes)
                    .join("g")
                    .attr("class", "node-group")
                    .attr("transform", d => `translate(${d.x || width/2}, ${d.y || height/2})`)
                    .on("mouseover", function(event, d) {
                        d3.select(this).classed("hovered", true);
                        d3.select(this).raise();

                        // Ïõê ÌÅ¨Í∏∞Î•º 1.4Î∞∞Î°ú Ï¶ùÍ∞Ä -> Ï£ºÎ≥Ä ÏõêÎì§Ïù¥ Î∞ÄÎ†§ÎÇ®
                        d.targetR = d.r * 1.4;

                        // ÏãúÎÆ¨Î†àÏù¥ÏÖò Ïû¨ÏãúÏûë (Î∂ÄÎìúÎü¨Ïö¥ Ïï†ÎãàÎ©îÏù¥ÏÖò)
                        simulation.alpha(0.3).restart();
                    })
                    .on("mouseout", function(event, d) {
                        d3.select(this).classed("hovered", false);

                        // ÏõêÎûò ÌÅ¨Í∏∞Î°ú Î≥µÍ∑Ä
                        d.targetR = d.r;

                        // ÏãúÎÆ¨Î†àÏù¥ÏÖò Ïû¨ÏãúÏûë
                        simulation.alpha(0.3).restart();
                    })
                    .on("click", function(event, d) {
                        window.location.href = `/topics/${d.id}`;
                    });

                nodeElements.append("circle")
                    .attr("class", d => `node ${d.type}`)
                    .attr("r", d => d.r)
                    .attr("fill", d => d.color);

                nodeElements.append("text")
                    .attr("class", d => `node-label ${d.type}`)
                    .attr("dy", "0.3em")
                    .style("font-size", "13px")
                    .text(d => {
                        // Ï†úÎ™© Ï≤´ Ïñ¥Ï†à
                        const words = d.name.split(' ');
                        return words[0] || d.name;
                    });

                // Ìà¥ÌåÅ (Ï†ÑÏ≤¥ Ï†úÎ™© + Í∏∞ÏÇ¨ Ïàò + Íµ≠Í∞Ä)
                nodeElements.append("title")
                    .text(d => `${d.name}\n${d.articleCount}Í∞ú Í∏∞ÏÇ¨\n${d.countryLabel}`);

                simulation.on("tick", () => {
                    // Ïõê ÌÅ¨Í∏∞Î•º targetRÎ°ú Î∂ÄÎìúÎüΩÍ≤å Î≥ÄÍ≤Ω
                    nodeElements.select("circle")
                        .attr("r", d => d.targetR);

                    nodeElements.attr("transform", d => `translate(${d.x}, ${d.y})`);
                });

                // Íµ≠Í∞Ä ÌÉ≠ ÏÉùÏÑ± (Ïã§Ï†ú Îç∞Ïù¥ÌÑ∞Í∞Ä ÏûàÎäî Íµ≠Í∞ÄÎßå)
                const countryTabsContainer = d3.select("#countryTabs");

                // Í∞Å Íµ≠Í∞ÄÎ≥Ñ ÌÉ≠
                allCountriesInData.forEach(countryCode => {
                    const flag = countryFlags[countryCode] || countryCode;
                    const isActive = countryCode === selectedCountry;

                    countryTabsContainer.append("div")
                        .attr("class", isActive ? "country-tab active" : "country-tab")
                        .text(flag)
                        .on("click", function() {
                            // Ìï¥Îãπ Íµ≠Í∞Ä ÎπÑÏª§Î°ú Ïù¥Îèô
                            window.location.href = `/map-beaker.html?country=${countryCode}`;
                        });
                });

            } catch (error) {
                console.error("Error fetching or processing data:", error);
                loadingText.text("Îç∞Ïù¥ÌÑ∞ Î°úÎî© Ïã§Ìå®!");
            }
        }

        drawChart();
    </script>
</body>
</html>
